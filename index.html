<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TechApex Sports Fixtures</title>
  <style>
    :root{--bg:#0b0f14;--card:#121a23;--text:#e7eef7;--muted:#9fb0c3;--line:#223040;--good:#6ee7b7;--bad:#fb7185;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,15,20,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    select,button{background:var(--card);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
    .pill.ok{color:var(--good);border-color:#0f3a2a}
    .pill.err{color:var(--bad);border-color:#3a0f19}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    th{font-size:12px;color:var(--muted);text-align:left}
    .teams{font-weight:650}
    .meta{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.35}
    .errorline{color:#ffb0b0}
    .debug{font-family:ui-monospace,Consolas,monospace;font-size:12px;color:var(--muted);word-break:break-all}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>TechApex Sports Fixtures</h1>
    <div class="sub">GitHub Pages frontend • Cloudflare Worker API</div>

    <div class="bar">
      <select id="category">
        <option value="football" selected>Football</option>
        <option value="motorsport">Motorsport</option>
      </select>

      <select id="sub"></select>

      <select id="view"></select>

      <button id="load">Load</button>

      <span id="state" class="pill">Ready</span>
    </div>

    <div class="meta">API base: <span class="debug" id="apiBase"></span></div>
    <div class="meta">Last request: <span class="debug" id="lastUrl">—</span></div>
    <div class="meta">Last status: <span class="debug" id="lastStatus">—</span></div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="head">
      <div id="title" class="teams">—</div>
      <div id="count" class="meta">0 items</div>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:260px;">Date / Time (UK)</th>
          <th>Event</th>
          <th style="width:180px;">Status</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="3" class="meta">Choose a category and press Load.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // IMPORTANT: keep this as workers.dev until your custom API domain is fully working
  const API = "https://football-api.aollaku.workers.dev";

  const apiBaseEl = document.getElementById("apiBase");
  const lastUrlEl = document.getElementById("lastUrl");
  const lastStatusEl = document.getElementById("lastStatus");
  apiBaseEl.textContent = API;

  const categorySel = document.getElementById("category");
  const subSel = document.getElementById("sub");
  const viewSel = document.getElementById("view");
  const btn = document.getElementById("load");

  const state = document.getElementById("state");
  const title = document.getElementById("title");
  const count = document.getElementById("count");
  const rows = document.getElementById("rows");

  const FOOTBALL_SUBS = [
    { id:"PL", name:"Premier League (PL)" },
    { id:"ELC", name:"EFL Championship (ELC)" },
    { id:"EL1", name:"EFL League One (EL1)" },
    { id:"EL2", name:"EFL League Two (EL2)" }
  ];

  const MOTORSPORT_SUBS = [
    { id:"f1", name:"Formula 1" },
    { id:"fe", name:"Formula E" },
    { id:"motogp", name:"MotoGP" },
    { id:"wec", name:"WEC" }
  ];

  const FOOTBALL_VIEWS = [
    { id:"live", name:"Live now" },
    { id:"upcoming", name:"Upcoming" },
    { id:"results", name:"Results (past)" }
  ];

  const F1_VIEWS = [
    { id:"upcoming", name:"Next race" },
    { id:"calendar", name:"Full calendar" },
    { id:"drivers", name:"Driver standings" },
    { id:"constructors", name:"Constructor standings" },
    { id:"results", name:"Last race results" }
  ];

  const MOTORSPORT_VIEWS = [
    { id:"upcoming", name:"Upcoming" },
    { id:"results", name:"Results (past)" }
  ];

  function setState(text, kind="") {
    state.className = "pill" + (kind ? " " + kind : "");
    state.textContent = text;
  }

  function fillSelect(sel, list){
    sel.innerHTML = "";
    for (const x of list){
      const o = document.createElement("option");
      o.value = x.id;
      o.textContent = x.name;
      sel.appendChild(o);
    }
    sel.selectedIndex = 0;
  }

  function fmtUK(iso){
    const d = new Date(iso);
    return new Intl.DateTimeFormat("en-GB", {
      timeZone:"Europe/London",
      weekday:"short", year:"numeric", month:"short", day:"2-digit",
      hour:"2-digit", minute:"2-digit"
    }).format(d);
  }

  function reset(msg){
    title.textContent = "—";
    count.textContent = "0 items";
    rows.innerHTML = `<tr><td colspan="3" class="meta">${msg}</td></tr>`;
  }

  async function fetchJson(url){
    // cache-bust
    const u = url + (url.includes("?") ? "&" : "?") + "_=" + Date.now();
    lastUrlEl.textContent = u;
    lastStatusEl.textContent = "…";

    const res = await fetch(u, { mode:"cors", cache:"no-store" });
    lastStatusEl.textContent = `${res.status} ${res.statusText}`;

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { throw new Error("Bad JSON (or blocked by CORS/OPTIONS)"); }

    if (!res.ok) throw new Error(data?.error || data?.message || `HTTP ${res.status}`);
    return data;
  }

  function buildFootballUrl(comp, view){
    let status = "SCHEDULED";
    if (view === "results") status = "FINISHED";
    if (view === "live") status = "IN_PLAY,PAUSED";
    const target = `https://api.football-data.org/v4/competitions/${encodeURIComponent(comp)}/matches?status=${encodeURIComponent(status)}`;
    return `${API}/?url=${encodeURIComponent(target)}`;
  }

  function buildF1Url(view){
    return `${API}/v2/f1?view=${encodeURIComponent(view)}`;
  }

  function buildMotorsportUrl(series, view){
    return `${API}/v2/motorsport?series=${encodeURIComponent(series)}&view=${encodeURIComponent(view)}`;
  }

  function renderSimpleList(items, titleText){
    title.textContent = titleText;
    count.textContent = `${items.length} items`;
    if (!items.length) return reset("No items returned.");
    rows.innerHTML = items.map(it => `
      <tr>
        <td>${it.when || "—"}</td>
        <td><div class="teams">${it.name || "—"}</div><div class="meta">${it.meta || ""}</div></td>
        <td>${it.status || "—"}</td>
      </tr>
    `).join("");
  }

  async function load(){
    try {
      setState("Loading…");
      reset("Loading…");

      const cat = categorySel.value;
      const sub = subSel.value;
      const view = viewSel.value;

      let data;

      if (cat === "football") {
        data = await fetchJson(buildFootballUrl(sub, view));
        const matches = data.matches || [];
        const items = matches.map(m => ({
          when: m.utcDate ? fmtUK(m.utcDate) : "—",
          name: `${m.homeTeam?.name || "Home"} vs ${m.awayTeam?.name || "Away"}`,
          meta: m.stage || "",
          status: m.status || ""
        }));
        renderSimpleList(items, data.competition?.name || "Football");
      } else {
        if (sub === "f1") {
          data = await fetchJson(buildF1Url(view));
          const races = data?.MRData?.RaceTable?.Races || [];
          const items = races.map(r => {
            const iso = (r.date && r.time) ? `${r.date}T${r.time}` : (r.date ? `${r.date}T00:00:00Z` : null);
            return {
              when: iso ? fmtUK(iso) : "—",
              name: r.raceName || "Race",
              meta: r.Circuit?.circuitName || "",
              status: view === "results" ? "Finished" : "Scheduled"
            };
          });
          renderSimpleList(items, "Formula 1");
        } else {
          data = await fetchJson(buildMotorsportUrl(sub, view));
          const events = data.events || [];
          const items = events.map(e => ({
            when: e.startTimeUtc ? fmtUK(e.startTimeUtc) : "—",
            name: e.name || "Event",
            meta: [e.venue, e.location].filter(Boolean).join(" — "),
            status: e.status || ""
          }));
          renderSimpleList(items, data.league?.name || "Motorsport");
        }
      }

      setState("Updated", "ok");
    } catch (e) {
      setState("Error", "err");
      rows.innerHTML = `<tr><td colspan="3" class="meta errorline">Error: ${String(e.message || e)}</td></tr>`;
      count.textContent = "0 items";
    }
  }

  function init(){
    if (categorySel.value === "football") {
      fillSelect(subSel, FOOTBALL_SUBS);
      fillSelect(viewSel, FOOTBALL_VIEWS);
    } else {
      fillSelect(subSel, MOTORSPORT_SUBS);
      fillSelect(viewSel, subSel.value === "f1" ? F1_VIEWS : MOTORSPORT_VIEWS);
    }
  }

  categorySel.addEventListener("change", () => { init(); load(); });
  subSel.addEventListener("change", () => {
    if (categorySel.value === "motorsport") {
      fillSelect(viewSel, subSel.value === "f1" ? F1_VIEWS : MOTORSPORT_VIEWS);
    }
    load();
  });
  viewSel.addEventListener("change", load);
  btn.addEventListener("click", load);

  init();
  load();
</script>
</body>
</html>
