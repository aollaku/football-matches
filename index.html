<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TechApex Sports Fixtures</title>
  <style>
    :root { --bg:#0b0f14; --card:#121a23; --text:#e7eef7; --muted:#9fb0c3; --line:#223040; --good:#6ee7b7; --warn:#fbbf24; --bad:#fb7185; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,15,20,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    select,button{background:var(--card);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
    .pill.live{color:var(--warn);border-color:#3a2a00}
    .pill.ok{color:var(--good);border-color:#0f3a2a}
    .pill.err{color:var(--bad);border-color:#3a0f19}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    th{font-size:12px;color:var(--muted);text-align:left}
    .teams{font-weight:650}
    .meta{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.35}
    .tag{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .tag.live{border-color:#3a2a00;color:var(--warn)}
    .tag.ft{border-color:#0f3a2a;color:var(--good)}
    .tag.ns{border-color:#223040;color:var(--muted)}
    .score{font-weight:750}
    .kickoff{white-space:nowrap}
    .errorline{color:#ffb0b0}
    .row-compact td{padding-top:12px;padding-bottom:12px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .toggle{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}
    .toggle input{transform:translateY(1px)}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>TechApex Sports Fixtures</h1>
    <div class="sub">Live fixtures + results • GitHub Pages frontend • Cloudflare Worker API</div>

    <div class="bar">
      <!-- 1st dropdown: Category -->
      <select id="category">
        <option value="football" selected>Football</option>
        <option value="motorsport">Motorsport</option>
      </select>

      <!-- 2nd dropdown: Sub-category (League/Series) -->
      <select id="sub"></select>

      <!-- 3rd dropdown: View -->
      <select id="view"></select>

      <button id="load">Load</button>

      <div class="controls">
        <label class="toggle">
          <input type="checkbox" id="autorefresh" checked />
          Auto refresh
        </label>
        <select id="refreshRate" title="Refresh interval">
          <option value="15">15s</option>
          <option value="30" selected>30s</option>
          <option value="60">60s</option>
        </select>
      </div>

      <span id="state" class="pill">Ready</span>
    </div>
    <div class="small" id="hint"></div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="head">
      <div id="title" class="teams">—</div>
      <div id="count" class="meta">0 items</div>
    </div>

    <table>
      <thead>
        <tr>
          <th id="col1" style="width:260px;">Date / Time (UK)</th>
          <th id="col2">Event</th>
          <th id="col3" style="width:180px;">Status</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="3" class="meta">Choose a category and press Load.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // ✅ Your Worker base URL
  const API = "https://football-api.aollaku.workers.dev";

  const categorySel = document.getElementById("category");
  const subSel = document.getElementById("sub");
  const viewSel = document.getElementById("view");
  const btn = document.getElementById("load");
  const autoSel = document.getElementById("autorefresh");
  const rateSel = document.getElementById("refreshRate");

  const state = document.getElementById("state");
  const hint = document.getElementById("hint");
  const title = document.getElementById("title");
  const count = document.getElementById("count");
  const rows = document.getElementById("rows");

  const col1 = document.getElementById("col1");
  const col2 = document.getElementById("col2");
  const col3 = document.getElementById("col3");

  // -------------------------
  // Sub-category lists
  // -------------------------
  const FOOTBALL_SUBS = [
    { id: "PL",  name: "Premier League (PL)" },
    { id: "ELC", name: "EFL Championship (ELC)" },
    { id: "EL1", name: "EFL League One (EL1)" },
    { id: "EL2", name: "EFL League Two (EL2)" },
    { id: "BL1", name: "Bundesliga (BL1)" },
    { id: "SA",  name: "Serie A (SA)" },
    { id: "PD",  name: "La Liga (PD)" },
    { id: "FL1", name: "Ligue 1 (FL1)" },
    { id: "CL",  name: "UEFA Champions League (CL)" }
  ];

  const MOTORSPORT_SUBS = [
    { id: "f1", name: "Formula 1" },
    { id: "fe", name: "Formula E" }
  ];

  // Views by category/sub-category
  const FOOTBALL_VIEWS = [
    { id: "live",     name: "Live now" },
    { id: "upcoming", name: "Upcoming" },
    { id: "results",  name: "Results (past)" }
  ];

  const F1_VIEWS = [
    { id: "upcoming",     name: "Next race" },
    { id: "calendar",     name: "Full season calendar" },
    { id: "drivers",      name: "Driver standings" },
    { id: "constructors", name: "Constructor standings" },
    { id: "results",      name: "Last race results" }
  ];

  const FE_VIEWS = [
    { id: "upcoming", name: "Upcoming" },
    { id: "results",  name: "Results (past)" }
  ];

  let latestToken = 0;
  let activeAbort = null;
  let refreshTimer = null;

  function setState(text, kind="") {
    state.className = "pill" + (kind ? " " + kind : "");
    state.textContent = text;
  }

  function setColumns(a,b,c){ col1.textContent=a; col2.textContent=b; col3.textContent=c; }

  function resetTable(msg){
    title.textContent = "—";
    count.textContent = "0 items";
    rows.innerHTML = `<tr><td colspan="3" class="meta">${msg}</td></tr>`;
  }

  function fillSelect(select, list){
    select.innerHTML = "";
    for (const x of list){
      const opt = document.createElement("option");
      opt.value = x.id;
      opt.textContent = x.name;
      select.appendChild(opt);
    }
    select.selectedIndex = 0;
  }

  function fmtUKFromISO(isoUtc){
    const d = new Date(isoUtc);
    return new Intl.DateTimeFormat("en-GB", {
      timeZone: "Europe/London",
      weekday:"short", year:"numeric", month:"short", day:"2-digit",
      hour:"2-digit", minute:"2-digit"
    }).format(d);
  }

  async function fetchJson(url, signal){
    const u = url + (url.includes("?") ? "&" : "?") + "_=" + Date.now();
    const res = await fetch(u, { cache:"no-store", signal });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { throw new Error("Bad JSON"); }
    if (!res.ok) throw new Error(data?.message || data?.error || `HTTP ${res.status}`);
    return data;
  }

  // -------------------------
  // Build API URLs
  // -------------------------
  function buildFootballUrl(compCode, view){
    let statusParam;
    if (view === "results") statusParam = "FINISHED";
    else if (view === "live") statusParam = "IN_PLAY,PAUSED";
    else statusParam = "SCHEDULED";

    const target = `https://api.football-data.org/v4/competitions/${encodeURIComponent(compCode)}/matches?status=${encodeURIComponent(statusParam)}`;
    return `${API}/?url=${encodeURIComponent(target)}`;
  }

  function buildF1Url(view){
    return `${API}/v2/f1?view=${encodeURIComponent(view)}`;
  }

  function buildFEUrl(view){
    return `${API}/v2/fe?view=${encodeURIComponent(view)}`;
  }

  // -------------------------
  // Render: Football
  // -------------------------
  function scoreText(m){
    const ft = m?.score?.fullTime;
    const ht = m?.score?.halfTime;

    if (m.status === "FINISHED" && ft && (ft.home != null || ft.away != null)) {
      return `<span class="score">${ft.home ?? "-"} - ${ft.away ?? "-"}</span>`;
    }

    // For LIVE some plans/providers still only fill fullTime at end,
    // but we show what we get.
    if ((m.status === "IN_PLAY" || m.status === "PAUSED") && ft && (ft.home != null || ft.away != null)) {
      return `<span class="score">${ft.home ?? "-"} - ${ft.away ?? "-"}</span>`;
    }

    // If no score available yet
    return `<span class="muted">vs</span>`;
  }

  function statusTag(m){
    const s = m.status || "";
    if (s === "IN_PLAY" || s === "PAUSED") return `<span class="tag live">LIVE</span>`;
    if (s === "FINISHED") return `<span class="tag ft">FT</span>`;
    return `<span class="tag ns">${s || "—"}</span>`;
  }

  function liveTimeText(m){
    // football-data.org typically does not provide live minute.
    if (m.status === "IN_PLAY") return "Live";
    if (m.status === "PAUSED") return "HT";
    return "";
  }

  function renderFootball(data, view){
    setColumns("Date / Time (UK)", "Match", "Status");
    const matches = data.matches || [];
    title.textContent = data.competition?.name || "Football";
    count.textContent = `${matches.length} matches`;

    if (!matches.length) {
      resetTable(view === "live" ? "No live matches right now." : "No matches returned.");
      return;
    }

    matches.sort((a,b) => (a.utcDate||"").localeCompare(b.utcDate||""));
    if (view === "results") matches.reverse();

    rows.innerHTML = matches.map(m => {
      const when = fmtUKFromISO(m.utcDate);
      const liveTxt = liveTimeText(m);
      const md = (m.matchday != null) ? `Matchday ${m.matchday}` : "";

      const ft = m?.score?.fullTime;
      const ht = m?.score?.halfTime;

      const resultLine = (m.status === "FINISHED" && (ft?.home != null || ft?.away != null))
        ? `FT: ${ft.home ?? "-"}-${ft.away ?? "-"}${(ht?.home != null || ht?.away != null) ? ` • HT: ${ht.home ?? "-"}-${ht.away ?? "-"}` : ""}`
        : "";

      return `
        <tr class="row-compact">
          <td class="kickoff">
            <div class="teams">${when}</div>
            <div class="meta">${md}${resultLine ? `<br>${resultLine}` : ""}</div>
          </td>
          <td>
            <div class="teams">
              ${m.homeTeam?.name || "Home"} ${scoreText(m)} ${m.awayTeam?.name || "Away"}
            </div>
            <div class="meta">${m.stage || ""}</div>
          </td>
          <td>
            ${statusTag(m)}
            ${liveTxt ? `<div class="meta">${liveTxt}</div>` : ""}
          </td>
        </tr>
      `;
    }).join("");
  }

  // -------------------------
  // Render: F1 (Jolpica Ergast)
  // -------------------------
  function buildSessionsMeta(r){
    const parts = [];
    const add = (label, obj) => {
      if (!obj || !obj.date) return;
      const iso = obj.time ? `${obj.date}T${obj.time}` : `${obj.date}T00:00:00Z`;
      parts.push(`${label}: ${fmtUKFromISO(iso)}`);
    };
    add("FP1", r.FirstPractice);
    add("FP2", r.SecondPractice);
    add("FP3", r.ThirdPractice);
    add("Quali", r.Qualifying);
    add("Sprint", r.Sprint);
    return parts.join(" • ");
  }

  function renderF1(data, view){
    if (view === "drivers" || view === "constructors") {
      setColumns("Pos", view === "drivers" ? "Driver / Team" : "Constructor", "Points");

      const lists = data?.MRData?.StandingsTable?.StandingsLists || [];
      const list0 = lists[0] || {};

      if (view === "drivers") {
        title.textContent = "F1 Driver Standings";
        const st = list0?.DriverStandings || [];
        count.textContent = `${st.length} drivers`;
        if (!st.length) return resetTable("No driver standings returned.");

        rows.innerHTML = st.map(s => {
          const drv = s.Driver ? `${s.Driver.givenName || ""} ${s.Driver.familyName || ""}`.trim() : "—";
          const team = s.Constructors?.[0]?.name || "";
          return `
            <tr>
              <td><div class="teams">${s.position || "-"}</div></td>
              <td>
                <div class="teams">${drv}</div>
                <div class="meta">${team}</div>
              </td>
              <td><span class="tag">${s.points || "0"} pts</span></td>
            </tr>`;
        }).join("");
        return;
      }

      title.textContent = "F1 Constructor Standings";
      const st = list0?.ConstructorStandings || [];
      count.textContent = `${st.length} constructors`;
      if (!st.length) return resetTable("No constructor standings returned.");

      rows.innerHTML = st.map(s => `
        <tr>
          <td><div class="teams">${s.position || "-"}</div></td>
          <td><div class="teams">${s.Constructor?.name || "—"}</div></td>
          <td><span class="tag">${s.points || "0"} pts</span></td>
        </tr>`).join("");
      return;
    }

    // upcoming/calendar/results (simple)
    setColumns("Date / Time (UK)", "Event", "Status");
    const races = data?.MRData?.RaceTable?.Races || [];
    title.textContent = "Formula 1";
    count.textContent = `${races.length} races`;

    if (!races.length) {
      return resetTable(view === "results" ? "No finished race yet." : "No races returned.");
    }

    races.sort((a,b) => (a.date||"").localeCompare(b.date||""));

    rows.innerHTML = races.map(r => {
      const isoRace = (r.date && r.time) ? `${r.date}T${r.time}` : `${r.date}T00:00:00Z`;
      const when = fmtUKFromISO(isoRace);

      const circuit = r.Circuit?.circuitName || "";
      const loc = r.Circuit?.Location;
      const place = loc ? `${loc.locality || ""}${loc.country ? (loc.locality ? ", " : "") + loc.country : ""}` : "";
      const venue = [circuit, place].filter(Boolean).join(" — ");

      const sessions = (view === "upcoming" || view === "calendar") ? buildSessionsMeta(r) : "";

      return `
        <tr class="row-compact">
          <td class="kickoff">
            <div class="teams">${when}</div>
            <div class="meta">${r.date || ""}</div>
          </td>
          <td>
            <div class="teams">${r.raceName || "Grand Prix"} (Round ${r.round || "-"})</div>
            <div class="meta">${venue}${sessions ? "<br>" + sessions : ""}</div>
          </td>
          <td><span class="tag">${view === "results" ? "Finished" : "Scheduled"}</span></td>
        </tr>`;
    }).join("");
  }

  // -------------------------
  // Render: Formula E (Worker /v2/fe normalized)
  // -------------------------
  function renderFE(data, view) {
    setColumns("Date / Time (UK)", "Event", "Status");
    const events = data.events || [];
    title.textContent = "Formula E";
    count.textContent = `${events.length} events`;

    if (!events.length) {
      return resetTable("No Formula E events returned.");
    }

    events.sort((a,b) => (a.startTimeUtc || "").localeCompare(b.startTimeUtc || ""));
    if (view === "results") events.reverse();

    rows.innerHTML = events.map(e => {
      const when = e.startTimeUtc ? fmtUKFromISO(e.startTimeUtc) : "—";
      const venueLine = [e.venue, e.location].filter(Boolean).join(" — ");
      const round = e.round ? `Round ${e.round}` : "";
      const season = e.season ? `Season ${e.season}` : "";
      const metaLine = [season, round].filter(Boolean).join(" • ");

      return `
        <tr class="row-compact">
          <td class="kickoff">
            <div class="teams">${when}</div>
            <div class="meta">${metaLine}</div>
          </td>
          <td>
            <div class="teams">${e.name || "Formula E Event"}</div>
            <div class="meta">${venueLine || ""}</div>
          </td>
          <td><span class="tag">${e.status || (view === "results" ? "Finished" : "Scheduled")}</span></td>
        </tr>
      `;
    }).join("");
  }

  // -------------------------
  // Auto-refresh
  // -------------------------
  function startAutoRefresh(){
    stopAutoRefresh();
    if (!autoSel.checked) return;

    const seconds = parseInt(rateSel.value || "30", 10);
    refreshTimer = setInterval(() => loadData({ silent:true }), seconds * 1000);
  }

  function stopAutoRefresh(){
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = null;
  }

  // -------------------------
  // Main load function
  // -------------------------
  async function loadData({ silent=false } = {}){
    if (activeAbort) activeAbort.abort();
    activeAbort = new AbortController();

    const token = ++latestToken;

    const category = categorySel.value; // football | motorsport
    const sub = subSel.value;           // PL/ELC... OR f1/fe
    const view = viewSel.value;

    if (!silent) {
      resetTable("Loading…");
      setState("Loading…");
    } else {
      setState("Updating…");
    }

    let apiUrl = "";

    if (category === "football") {
      apiUrl = buildFootballUrl(sub, view);
    } else if (category === "motorsport") {
      if (sub === "f1") apiUrl = buildF1Url(view);
      if (sub === "fe") apiUrl = buildFEUrl(view);
    }

    try {
      const data = await fetchJson(apiUrl, activeAbort.signal);
      if (token !== latestToken) return;

      if (category === "football") {
        renderFootball(data, view);
        if (view === "live") setState("Live", "live");
        else setState("Updated", "ok");
      } else if (category === "motorsport") {
        if (sub === "f1") renderF1(data, view);
        if (sub === "fe") renderFE(data, view);
        setState("Updated", "ok");
      }

      startAutoRefresh();
    } catch (e) {
      if (e.name === "AbortError") return;
      if (token !== latestToken) return;

      rows.innerHTML = `<tr><td colspan="3" class="meta errorline">Error: ${String(e.message || e)}</td></tr>`;
      count.textContent = "0 items";
      setState("Error", "err");
      startAutoRefresh();
    }
  }

  // -------------------------
  // Handle dropdown dependencies
  // -------------------------
  function updateSecondAndThirdDropdowns() {
    const category = categorySel.value;

    if (category === "football") {
      fillSelect(subSel, FOOTBALL_SUBS);
      fillSelect(viewSel, FOOTBALL_VIEWS);
      setColumns("Date / Time (UK)", "Match", "Status");
      hint.textContent = "Football uses football-data.org via your Worker.";
      return;
    }

    // Motorsport
    fillSelect(subSel, MOTORSPORT_SUBS);

    // Default to F1 views initially
    const sub = subSel.value || "f1";
    if (sub === "f1") {
      fillSelect(viewSel, F1_VIEWS);
      hint.textContent = "F1 uses Jolpica (Ergast-compatible) via your Worker.";
    } else {
      fillSelect(viewSel, FE_VIEWS);
      hint.textContent = "Formula E uses TheSportsDB via your Worker (/v2/fe).";
    }

    setColumns("Date / Time (UK)", "Event", "Status");
  }

  function onCategoryChange(){
    latestToken++;
    if (activeAbort) activeAbort.abort();
    stopAutoRefresh();
    setState("Ready");

    updateSecondAndThirdDropdowns();
    loadData();
  }

  function onSubChange(){
    // When Motorsport sub changes, change views list accordingly
    if (categorySel.value === "motorsport") {
      if (subSel.value === "f1") fillSelect(viewSel, F1_VIEWS);
      else fillSelect(viewSel, FE_VIEWS);
    }
    loadData();
  }

  categorySel.addEventListener("change", onCategoryChange);
  subSel.addEventListener("change", onSubChange);
  viewSel.addEventListener("change", () => loadData());
  btn.addEventListener("click", () => loadData());

  autoSel.addEventListener("change", startAutoRefresh);
  rateSel.addEventListener("change", startAutoRefresh);

  // Init
  (async () => {
    updateSecondAndThirdDropdowns();
    await loadData();
  })();
</script>
</body>
</html>
