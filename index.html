<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TechApex Sports Fixtures</title>
  <style>
    :root { --bg:#0b0f14; --card:#121a23; --text:#e7eef7; --muted:#9fb0c3; --line:#223040; --accent:#4aa3ff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,15,20,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    select,button{background:var(--card);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer;border-color:rgba(74,163,255,.45)}
    button:hover{background:rgba(74,163,255,.08)}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    th{font-size:12px;color:var(--muted);text-align:left}
    tr:hover td{background:rgba(255,255,255,.02)}
    .teams{font-weight:650}
    .meta{font-size:12px;color:var(--muted);margin-top:2px}
    .tag{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .errorline{color:#ffb0b0}
    .debug{margin-top:10px;color:var(--muted);font-size:12px}
    code{background:#0a0e13;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>TechApex Sports Fixtures</h1>
    <div class="sub">GitHub Pages frontend • Cloudflare Worker API gateway</div>

    <div class="bar">
      <select id="sport"></select>
      <select id="league"></select>

      <select id="view">
        <option value="next" selected>Upcoming</option>
        <option value="past">Results</option>
      </select>

      <button id="load">Load</button>
      <span id="state" class="pill">Ready</span>
    </div>

    <div class="debug" id="dbg"></div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="head">
      <div id="title" class="teams">—</div>
      <div id="count" class="meta">0 events</div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:260px;">Date / Time (UK)</th>
          <th>Event</th>
          <th style="width:130px;">Status</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="3" class="meta">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  const API = "https://api.techapex.co.uk";

  const sportSel = document.getElementById("sport");
  const leagueSel = document.getElementById("league");
  const viewSel  = document.getElementById("view");
  const btn      = document.getElementById("load");

  const state = document.getElementById("state");
  const title = document.getElementById("title");
  const count = document.getElementById("count");
  const rows  = document.getElementById("rows");
  const dbg   = document.getElementById("dbg");

  // Football main comps
  const FOOTBALL_MAIN = [
    { id: "4328", name: "English Premier League" },
    { id: "4329", name: "EFL Championship" },
    { id: "4396", name: "EFL League One" },
    { id: "4331", name: "German Bundesliga" },
    { id: "4332", name: "Italian Serie A" },
    { id: "4334", name: "French Ligue 1" },
    { id: "4335", name: "Spanish La Liga" },
    { id: "4401", name: "UEFA Champions League" },
    { id: "4668", name: "Saudi Pro League" }
  ];

  // F1 preset (league id on TSDB)
  const F1_PRESET = [{ id: "4370", name: "Formula 1" }];

  // Request guards to avoid stale “mixing”
  let leaguesReqId = 0;
  let eventsReqId  = 0;

  // Cache all leagues
  let ALL_LEAGUES = null;

  function setState(t){ state.textContent = t; }
  function setDbg(html){ dbg.innerHTML = html; }

  function resetTable(msg){
    title.textContent = "—";
    count.textContent = "0 events";
    rows.innerHTML = `<tr><td colspan="3" class="meta">${msg}</td></tr>`;
  }

  function ukTime(dateStr, timeStr){
    const iso = timeStr ? `${dateStr}T${timeStr}` : `${dateStr}T00:00:00`;
    const d = new Date(iso + "Z");
    return new Intl.DateTimeFormat("en-GB", {
      timeZone: "Europe/London",
      weekday: "short",
      year: "numeric",
      month: "short",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    }).format(d);
  }

  async function getJson(path){
    const res = await fetch(API + path, { cache: "no-store" });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { throw new Error("Bad JSON: " + text.slice(0,180)); }
    if (!res.ok) throw new Error(data?.message || data?.error || `HTTP ${res.status}`);
    return data;
  }

  function fillSelect(el, list, placeholder){
    el.innerHTML = "";
    if (!list.length) {
      el.innerHTML = `<option value="">${placeholder}</option>`;
      return;
    }
    for (const item of list) {
      const opt = document.createElement("option");
      opt.value = item.value;
      opt.textContent = item.label;
      el.appendChild(opt);
    }
    el.selectedIndex = 0;
  }

  async function ensureAllLeagues(){
    if (ALL_LEAGUES) return ALL_LEAGUES;
    const data = await getJson("/v2/tsdb/all_leagues");
    ALL_LEAGUES = data.leagues || [];
    return ALL_LEAGUES;
  }

  // Build Sport dropdown from real data + our curated categories
  async function loadSports(){
    setState("Loading sports…");
    resetTable("Loading sports…");

    const all = await ensureAllLeagues();

    // Unique sports actually present in API
    const sportsSet = new Set(
      all.map(l => (l.strSport || "").trim()).filter(Boolean)
    );

    // We show a friendly curated list, but only if it exists in the dataset
    const hasSoccer = sportsSet.has("Soccer");
    const hasTennis = sportsSet.has("Tennis");
    const hasGolf   = sportsSet.has("Golf");

    // Rugby might be tagged as "Rugby Union" / "Rugby League"
    const hasAnyRugby = Array.from(sportsSet).some(s => s.toLowerCase().includes("rugby"));

    // Motorsport tags vary; we’ll use preset regardless, but show it as a category
    const hasAnyMotorsport = Array.from(sportsSet).some(s => s.toLowerCase().includes("motor"));

    const sportsUI = [];
    if (hasSoccer) sportsUI.push({ value: "Soccer", label: "Football (Soccer)" });
    if (hasAnyRugby) sportsUI.push({ value: "__RUGBY__", label: "Rugby (Union/League)" });
    if (hasTennis) sportsUI.push({ value: "Tennis", label: "Tennis" });
    if (hasGolf) sportsUI.push({ value: "Golf", label: "Golf" });
    sportsUI.push({ value: "__F1__", label: "F1 (Formula 1)" });

    fillSelect(sportSel, sportsUI, "No sports found");

    setDbg(`Sports in API: <code>${Array.from(sportsSet).slice(0,12).join(", ")}</code>${sportsSet.size>12?"…":""}`);
    setState("Ready");
  }

  // Load leagues based on selected sport category
  async function loadLeagues(){
    const req = ++leaguesReqId;

    setState("Loading leagues…");
    leagueSel.innerHTML = `<option value="">Loading…</option>`;
    resetTable("Loading leagues…");

    const sportKey = sportSel.value;
    const all = await ensureAllLeagues();
    if (req !== leaguesReqId) return;

    // Soccer = curated list (best UX)
    if (sportKey === "Soccer") {
      const list = FOOTBALL_MAIN.map(x => ({ value: x.id, label: `${x.name} (${x.id})` }));
      fillSelect(leagueSel, list, "No leagues");
      title.textContent = "Football leagues loaded";
      setState("Ready");
      return;
    }

    // F1 = preset
    if (sportKey === "__F1__") {
      const list = F1_PRESET.map(x => ({ value: x.id, label: `${x.name} (${x.id})` }));
      fillSelect(leagueSel, list, "No leagues");
      title.textContent = "F1 loaded";
      setState("Ready");
      return;
    }

    // Rugby category: match any sport that contains “rugby”
    const wanted = sportKey === "__RUGBY__"
      ? (s) => (s || "").toLowerCase().includes("rugby")
      : (s) => (s || "").toLowerCase() === sportKey.toLowerCase();

    const leagues = all
      .filter(l => wanted(l.strSport))
      .filter(l => l.idLeague && l.strLeague)
      .map(l => ({ value: l.idLeague, label: `${l.strLeague} (${l.idLeague})` }))
      .sort((a,b) => a.label.localeCompare(b.label));

    fillSelect(leagueSel, leagues, "No leagues found for this sport");
    title.textContent = leagues.length ? "Leagues loaded" : "No leagues found";
    setState("Ready");
  }

  function normalizeStatus(ev) {
    if (ev.strStatus) return ev.strStatus;
    if (ev.intHomeScore !== null && ev.intHomeScore !== "" && ev.intHomeScore !== undefined) return "FT";
    return "NS";
  }

  async function loadEvents(){
    const req = ++eventsReqId;

    const league = leagueSel.value;
    const mode   = viewSel.value;

    resetTable("Loading…");
    setState("Loading…");

    if (!league) {
      resetTable("No league selected.");
      setState("Ready");
      return;
    }

    const path = `/v2/tsdb/events?league=${encodeURIComponent(league)}&mode=${encodeURIComponent(mode)}`;
    setDbg(`${dbg.innerHTML}<br>Query: <code>${path}</code>`);

    try{
      const data = await getJson(path);
      if (req !== eventsReqId) return;

      const events = data.events || [];
      if (!events.length) {
        resetTable("No events returned (try Results or choose another league).");
        setState("Updated");
        return;
      }

      events.sort((a,b) => ((a.dateEvent||"")+(a.strTime||"")).localeCompare((b.dateEvent||"")+(b.strTime||"")));

      const leagueName = events[0].strLeague || leagueSel.options[leagueSel.selectedIndex]?.textContent || "Events";
      title.textContent = leagueName;
      count.textContent = `${events.length} event${events.length===1?"":"s"}`;

      rows.innerHTML = events.map(ev => {
        const when = ukTime(ev.dateEvent, ev.strTime);
        const status = normalizeStatus(ev);

        let label = "";
        if (ev.strHomeTeam && ev.strAwayTeam) {
          const hs = ev.intHomeScore ?? "";
          const as = ev.intAwayScore ?? "";
          label = `${ev.strHomeTeam} vs ${ev.strAwayTeam}` + (hs!=="" && as!=="" ? ` (${hs}-${as})` : "");
        } else {
          label = ev.strEvent || "—";
        }

        return `
          <tr>
            <td><div class="teams">${when}</div><div class="meta">${ev.dateEvent || ""}</div></td>
            <td><div class="teams">${label}</div><div class="meta">${ev.strVenue || ev.strCountry || ""}</div></td>
            <td><span class="tag">${status}</span></td>
          </tr>
        `;
      }).join("");

      setState("Updated");
    } catch(e){
      if (req !== eventsReqId) return;
      rows.innerHTML = `<tr><td colspan="3" class="meta errorline">Error: ${String(e.message || e)}</td></tr>`;
      count.textContent = "0 events";
      setState("Error");
      console.error(e);
    }
  }

  // Wiring
  sportSel.addEventListener("change", async () => {
    eventsReqId++; // invalidate in-flight events
    await loadLeagues();
    await loadEvents();
  });

  leagueSel.addEventListener("change", loadEvents);
  viewSel.addEventListener("change", loadEvents);
  btn.addEventListener("click", loadEvents);

  // Init
  (async () => {
    await loadSports();
    await loadLeagues();
    await loadEvents();
  })();
</script>
</body>
</html>
