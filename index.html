<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TechApex Fixtures</title>
  <style>
    :root { --bg:#0b0f14; --card:#121a23; --text:#e7eef7; --muted:#9fb0c3; --line:#223040; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,15,20,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    select,button{background:var(--card);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    th{font-size:12px;color:var(--muted);text-align:left}
    tr:hover td{background:rgba(255,255,255,.02)}
    .teams{font-weight:650}
    .meta{font-size:12px;color:var(--muted);margin-top:2px}
    .tag{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .errorline{color:#ffb0b0}
    .debug{margin-top:10px;color:var(--muted);font-size:12px}
    code{background:#0a0e13;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>TechApex Fixtures</h1>
    <div class="sub">GitHub Pages frontend • Cloudflare Worker API gateway</div>

    <div class="bar">
      <select id="sport">
        <option value="football" selected>Football</option>
        <option value="f1">F1</option>
      </select>

      <select id="league"></select>

      <select id="view">
        <option value="upcoming" selected>Upcoming</option>
        <option value="results">Results</option>
      </select>

      <button id="load">Load</button>
      <span id="state" class="pill">Ready</span>
    </div>

    <div class="debug" id="dbg"></div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="head">
      <div id="title" class="teams">—</div>
      <div id="count" class="meta">0 items</div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:260px;">Date / Time (UK)</th>
          <th>Event</th>
          <th style="width:140px;">Status</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="3" class="meta">Select a league and press Load.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // ✅ THIS is your Worker domain (from your screenshot)
  const API = "https://football-api.aollaku.workers.dev";

  const sportSel = document.getElementById("sport");
  const leagueSel = document.getElementById("league");
  const viewSel  = document.getElementById("view");
  const btn      = document.getElementById("load");
  const state    = document.getElementById("state");
  const titleEl  = document.getElementById("title");
  const countEl  = document.getElementById("count");
  const rowsEl   = document.getElementById("rows");
  const dbgEl    = document.getElementById("dbg");

  // football-data.org competition codes
  const FOOTBALL_LEAGUES = [
    { id: "PL",  name: "Premier League (PL)" },
    { id: "ELC", name: "EFL Championship (ELC)" },
    { id: "BL1", name: "Bundesliga (BL1)" },
    { id: "SA",  name: "Serie A (SA)" },
    { id: "PD",  name: "La Liga (PD)" },
    { id: "FL1", name: "Ligue 1 (FL1)" },
    { id: "CL",  name: "UEFA Champions League (CL)" }
  ];

  const F1_LEAGUES = [
    { id: "4370", name: "Formula 1 (TheSportsDB league 4370)" }
  ];

  // Prevent “mixing” (stale responses overwriting new selection)
  let reqId = 0;

  function setState(t){ state.textContent = t; }
  function resetTable(msg){
    titleEl.textContent = "—";
    countEl.textContent = "0 items";
    rowsEl.innerHTML = `<tr><td colspan="3" class="meta">${msg}</td></tr>`;
  }

  function fillLeagues(list){
    leagueSel.innerHTML = "";
    for (const x of list) {
      const opt = document.createElement("option");
      opt.value = x.id;
      opt.textContent = x.name;
      leagueSel.appendChild(opt);
    }
    leagueSel.selectedIndex = 0;
  }

  function fmtUKFromISO(isoUtc){
    const d = new Date(isoUtc);
    return new Intl.DateTimeFormat("en-GB", {
      timeZone: "Europe/London",
      weekday: "short", year: "numeric", month: "short", day: "2-digit",
      hour: "2-digit", minute: "2-digit"
    }).format(d);
  }

  function fmtUKFromDateTime(dateStr, timeStr){
    const iso = timeStr ? `${dateStr}T${timeStr}` : `${dateStr}T00:00:00`;
    const d = new Date(iso + "Z");
    return new Intl.DateTimeFormat("en-GB", {
      timeZone: "Europe/London",
      weekday: "short", year: "numeric", month: "short", day: "2-digit",
      hour: "2-digit", minute: "2-digit"
    }).format(d);
  }

  async function fetchJson(url){
    const u = url + (url.includes("?") ? "&" : "?") + "_=" + Date.now();
    const res = await fetch(u, { cache: "no-store" });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { throw new Error("Bad JSON: " + text.slice(0,160)); }
    if (!res.ok) throw new Error(data?.message || data?.error || `HTTP ${res.status}`);
    return data;
  }

  function buildFootballUrl(compCode, view){
    const status = (view === "results") ? "FINISHED" : "SCHEDULED";
    const target = `https://api.football-data.org/v4/competitions/${encodeURIComponent(compCode)}/matches?status=${encodeURIComponent(status)}`;
    return `${API}/?url=${encodeURIComponent(target)}`;
  }

  function buildF1Url(view){
    const mode = (view === "results") ? "past" : "next";
    return `${API}/v2/tsdb/events?league=4370&mode=${encodeURIComponent(mode)}`;
  }

  async function loadData(){
    const my = ++reqId;

    const sport = sportSel.value;
    const league = leagueSel.value;
    const view = viewSel.value;

    resetTable("Loading…");
    setState("Loading…");

    let apiUrl = "";
    if (sport === "football") apiUrl = buildFootballUrl(league, view);
    if (sport === "f1") apiUrl = buildF1Url(view);

    dbgEl.innerHTML = `Sport=<code>${sport}</code> • League=<code>${league}</code> • View=<code>${view}</code><br>API=<code>${apiUrl}</code>`;

    try {
      const data = await fetchJson(apiUrl);
      if (my !== reqId) return;

      if (sport === "football") {
        const matches = data.matches || [];
        if (!matches.length) { resetTable("No matches returned."); setState("Updated"); return; }

        titleEl.textContent = data.competition?.name || leagueSel.options[leagueSel.selectedIndex]?.textContent || "Football";
        countEl.textContent = `${matches.length} match${matches.length===1?"":"es"}`;

        matches.sort((a,b) => (a.utcDate||"").localeCompare(b.utcDate||""));

        rowsEl.innerHTML = matches.map(m => {
          const when = fmtUKFromISO(m.utcDate);
          const home = m.homeTeam?.name || "Home";
          const away = m.awayTeam?.name || "Away";
          const status = m.status || "";
          const md = (m.matchday != null) ? `MD ${m.matchday}` : "";
          return `
            <tr>
              <td><div class="teams">${when}</div><div class="meta">${md}</div></td>
              <td><div class="teams">${home} vs ${away}</div><div class="meta">${m.stage || ""}</div></td>
              <td><span class="tag">${status}</span></td>
            </tr>`;
        }).join("");

        setState("Updated");
        return;
      }

      if (sport === "f1") {
        const events = data.events || [];
        if (!events.length) { resetTable("No F1 events returned."); setState("Updated"); return; }

        titleEl.textContent = "Formula 1";
        countEl.textContent = `${events.length} event${events.length===1?"":"s"}`;

        events.sort((a,b) => ((a.dateEvent||"")+(a.strTime||"")).localeCompare((b.dateEvent||"")+(b.strTime||"")));

        rowsEl.innerHTML = events.map(ev => {
          const when = fmtUKFromDateTime(ev.dateEvent, ev.strTime);
          const name = ev.strEvent || "Race";
          const venue = ev.strVenue || ev.strCountry || "";
          const st = ev.strStatus || "—";
          return `
            <tr>
              <td><div class="teams">${when}</div><div class="meta">${ev.dateEvent || ""}</div></td>
              <td><div class="teams">${name}</div><div class="meta">${venue}</div></td>
              <td><span class="tag">${st}</span></td>
            </tr>`;
        }).join("");

        setState("Updated");
      }
    } catch (e) {
      if (my !== reqId) return;
      rowsEl.innerHTML = `<tr><td colspan="3" class="meta errorline">Error: ${String(e.message || e)}</td></tr>`;
      countEl.textContent = "0 items";
      setState("Error");
    }
  }

  async function loadLeaguesForSport(){
    reqId++; // invalidate any in-flight request
    const sport = sportSel.value;

    if (sport === "football") {
      fillLeagues(FOOTBALL_LEAGUES);
      titleEl.textContent = "Football";
      setState("Ready");
      await loadData();
      return;
    }

    if (sport === "f1") {
      fillLeagues(F1_LEAGUES);
      titleEl.textContent = "Formula 1";
      setState("Ready");
      await loadData();
      return;
    }
  }

  sportSel.addEventListener("change", loadLeaguesForSport);
  leagueSel.addEventListener("change", loadData);
  viewSel.addEventListener("change", loadData);
  btn.addEventListener("click", loadData);

  (async () => { await loadLeaguesForSport(); })();
</script>
</body>
</html>
