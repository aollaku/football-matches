<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Premier League + EFL Fixtures</title>
  <style>
    :root { --bg:#0b0f14; --card:#121a23; --text:#e7eef7; --muted:#9fb0c3; --line:#223040; --accent:#4aa3ff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,15,20,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    select,button,input,label{
      background:var(--card);color:var(--text);
      border:1px solid var(--line);border-radius:10px;
      padding:10px 12px;font-size:14px;outline:none
    }
    input{min-width:170px}
    button{cursor:pointer;border-color:rgba(74,163,255,.45)}
    button:hover{background:rgba(74,163,255,.08)}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    th{font-size:12px;color:var(--muted);text-align:left}
    tr:hover td{background:rgba(255,255,255,.02)}
    .teams{font-weight:650}
    .meta{font-size:12px;color:var(--muted);margin-top:2px}
    .statusTag{display:inline-block;margin-top:6px;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .live{color:#ffb0b0;border-color:rgba(255,176,176,.35)}
    .ft{color:#bfe3c6;border-color:rgba(191,227,198,.35)}
    .crest{width:18px;height:18px;vertical-align:-3px;margin-right:8px;border-radius:3px}
    .rowMatch{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Premier League + EFL Fixtures</h1>
    <div class="sub">Frontend: GitHub Pages • Data: football-data.org via your Cloudflare Worker</div>

    <div class="bar">
      <select id="comp">
        <option value="PL">Premier League</option>
        <option value="ELC">EFL Championship</option>
      </select>

      <select id="view">
        <option value="upcoming" selected>Upcoming</option>
        <option value="live">Live now</option>
        <option value="finished">Finished</option>
        <option value="all">All</option>
      </select>

      <select id="range">
        <option value="all" selected>All dates</option>
        <option value="today">Today</option>
        <option value="tomorrow">Tomorrow</option>
        <option value="7d">Next 7 days</option>
      </select>

      <input id="q" placeholder="Search team…" />
      <input id="matchday" type="number" min="1" placeholder="Matchday (optional)" style="width:170px;"/>

      <button id="load">Load</button>
      <span id="state" class="pill">Ready</span>

      <div class="right">
        <label class="small" style="display:flex;align-items:center;gap:8px;">
          <input id="auto" type="checkbox" style="min-width:auto;margin:0;" />
          Auto refresh
        </label>
        <select id="every" style="min-width:140px;">
          <option value="30">30s</option>
          <option value="60" selected>60s</option>
          <option value="300">5 min</option>
        </select>

        <label class="small" style="display:flex;align-items:center;gap:8px;">
          <input id="crests" type="checkbox" checked style="min-width:auto;margin:0;" />
          Team crests
        </label>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="head">
      <div id="title" class="teams">—</div>
      <div id="count" class="meta">0 matches</div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:250px;">Date / Time (UK)</th>
          <th>Match</th>
          <th style="width:110px;">Matchday</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="3" class="meta">Press Load.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  const WORKER_API = "https://api.techapex.co.uk";

  const compSel = document.getElementById("comp");
  const viewSel = document.getElementById("view");
  const rangeSel = document.getElementById("range");
  const qInp = document.getElementById("q");
  const mdInp = document.getElementById("matchday");
  const btn = document.getElementById("load");
  const state = document.getElementById("state");
  const title = document.getElementById("title");
  const count = document.getElementById("count");
  const rows = document.getElementById("rows");
  const autoChk = document.getElementById("auto");
  const everySel = document.getElementById("every");
  const crestsChk = document.getElementById("crests");

  let timer = null;

  function setState(t){ state.textContent = t; }

  function ukTime(utcIso){
    return new Intl.DateTimeFormat("en-GB", {
      timeZone: "Europe/London",
      weekday: "short",
      year: "numeric",
      month: "short",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    }).format(new Date(utcIso));
  }

  function ymd(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  // ✅ Default ranges by view to keep responses fast, unless user chooses a manual range.
  function getDateRangeParam(){
    const now = new Date();
    const r = rangeSel.value;
    const view = viewSel.value;

    if (r === "today") return { dateFrom: ymd(now), dateTo: ymd(now) };
    if (r === "tomorrow") {
      const t = new Date(now); t.setDate(t.getDate()+1);
      return { dateFrom: ymd(t), dateTo: ymd(t) };
    }
    if (r === "7d") {
      const to = new Date(now); to.setDate(to.getDate()+7);
      return { dateFrom: ymd(now), dateTo: ymd(to) };
    }

    if (view === "upcoming" || view === "live") {
      const to = new Date(now); to.setDate(to.getDate()+30);
      return { dateFrom: ymd(now), dateTo: ymd(to) };
    }
    if (view === "finished") {
      const from = new Date(now); from.setDate(from.getDate()-30);
      return { dateFrom: ymd(from), dateTo: ymd(now) };
    }

    return null; // all
  }

  async function fetchMatches(){
    const code = compSel.value;

    // ✅ Do NOT send status=... (multi-status can break). We'll filter client-side.
    const range = getDateRangeParam();
    const qs = new URLSearchParams();
    if (range) { qs.set("dateFrom", range.dateFrom); qs.set("dateTo", range.dateTo); }

    const target = `https://api.football-data.org/v4/competitions/${code}/matches` + (qs.toString() ? `?${qs}` : "");
    const proxied = `${WORKER_API}/?url=${encodeURIComponent(target)}`;

    const res = await fetch(proxied);
    const text = await res.text();

    let data;
    try { data = JSON.parse(text); }
    catch { throw new Error("Bad JSON: " + text.slice(0,120)); }

    if (!res.ok) throw new Error(data?.message || data?.error || `HTTP ${res.status}`);
    return data;
  }

  function statusClass(st){
    if (st === "IN_PLAY" || st === "PAUSED") return "statusTag live";
    if (st === "FINISHED") return "statusTag ft";
    return "statusTag";
  }

  function render(matches){
    const q = (qInp.value || "").trim().toLowerCase();
    const md = (mdInp.value || "").trim();
    const v = viewSel.value;

    let list = Array.isArray(matches) ? matches.slice() : [];

    // View filter
    if (v === "upcoming") list = list.filter(m => ["SCHEDULED","TIMED"].includes(m.status));
    if (v === "live") list = list.filter(m => ["IN_PLAY","PAUSED"].includes(m.status));
    if (v === "finished") list = list.filter(m => ["FINISHED"].includes(m.status));

    // Matchday filter
    if (md) list = list.filter(m => String(m.matchday ?? "") === String(md));

    // Search filter
    if (q) {
      list = list.filter(m => {
        const h = (m.homeTeam?.name || "").toLowerCase();
        const a = (m.awayTeam?.name || "").toLowerCase();
        return h.includes(q) || a.includes(q);
      });
    }

    if (!list.length){
      rows.innerHTML = `<tr><td colspan="3" class="meta">No matches for your filters.</td></tr>`;
      count.textContent = "0 matches";
      return;
    }

    list.sort((a,b)=> new Date(a.utcDate) - new Date(b.utcDate));
    count.textContent = `${list.length} match${list.length===1?"":"es"}`;

    const showCrests = crestsChk.checked;

    rows.innerHTML = list.map(m=>{
      const when = ukTime(m.utcDate);
      const home = m.homeTeam?.name || "—";
      const away = m.awayTeam?.name || "—";
      const md = (m.matchday ?? "—");
      const st = m.status || "";
      const crestH = m.homeTeam?.crest || "";
      const crestA = m.awayTeam?.crest || "";

      const homeHtml = showCrests && crestH ? `<img class="crest" src="${crestH}" alt="">${home}` : home;
      const awayHtml = showCrests && crestA ? `<img class="crest" src="${crestA}" alt="">${away}` : away;

      return `
        <tr>
          <td>
            <div class="teams">${when}</div>
            <span class="${statusClass(st)}">${st}</span>
          </td>
          <td>
            <div class="rowMatch">
              <span class="teams">${homeHtml}</span>
              <span class="meta">vs</span>
              <span class="teams">${awayHtml}</span>
            </div>
            <div class="meta">${m.stage || ""}${m.group ? " • " + m.group : ""}</div>
          </td>
          <td><div class="teams">${md}</div></td>
        </tr>
      `;
    }).join("");
  }

  async function load(){
    setState("Loading…");
    rows.innerHTML = `<tr><td colspan="3" class="meta">Loading…</td></tr>`;

    try{
      const data = await fetchMatches();
      const code = compSel.value;
      title.textContent = `${data.competition?.name || code} (${code})`;
      render(data.matches || []);
      setState("Updated");
    }catch(e){
      title.textContent = compSel.value;
      rows.innerHTML = `<tr><td colspan="3" class="meta">Error: ${String(e.message || e)}</td></tr>`;
      setState("Error");
      console.error(e);
    }
  }

  function applyAutoRefresh(){
    if (timer) { clearInterval(timer); timer = null; }
    if (!autoChk.checked) return;

    const sec = parseInt(everySel.value, 10);
    timer = setInterval(load, sec * 1000);
  }

  btn.addEventListener("click", load);
  compSel.addEventListener("change", load);
  viewSel.addEventListener("change", load);
  rangeSel.addEventListener("change", load);
  qInp.addEventListener("input", load);
  mdInp.addEventListener("input", load);
  crestsChk.addEventListener("change", load);

  autoChk.addEventListener("change", applyAutoRefresh);
  everySel.addEventListener("change", applyAutoRefresh);

  load();
</script>
</body>
</html>
