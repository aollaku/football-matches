<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TechApex Sports Fixtures</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#0c121b;
      --text:#e8eef7; --muted:#9fb0c7; --line:#1b2a3a;
      --btn:#152235; --btn2:#0f1a2a; --good:#24d18b; --bad:#ff5b5b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:radial-gradient(1200px 600px at 20% 0%, #111b2a 0%, var(--bg) 55%, #06080c 100%);
      color:var(--text);
    }
    .wrap{max-width:1150px; margin:0 auto; padding:24px 16px 60px;}
    h1{font-size:28px; margin:0 0 6px;}
    .sub{color:var(--muted); margin:0 0 18px; font-size:13px}

    .bar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:14px; background:rgba(10,14,20,.55); border:1px solid var(--line);
      border-radius:14px;
    }
    select, button{
      background:linear-gradient(180deg, var(--btn) 0%, var(--btn2) 100%);
      color:var(--text); border:1px solid var(--line);
      border-radius:12px; padding:10px 12px; outline:none;
      font-size:14px;
    }
    button{cursor:pointer}
    button:hover{filter:brightness(1.08)}
    .pill{
      padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line);
      color:var(--muted);
    }
    .pill.good{color:var(--good); border-color:rgba(36,209,139,.25)}
    .pill.bad{color:var(--bad); border-color:rgba(255,91,91,.25)}
    .spacer{flex:1}
    label{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:13px}
    input[type="checkbox"]{transform:translateY(1px)}

    .card{
      margin-top:16px;
      background:rgba(12,18,27,.72);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
    }
    .cardhead{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(20,30,45,.55) 0%, rgba(12,18,27,.15) 100%);
    }
    .cardhead h2{margin:0; font-size:18px}
    .count{color:var(--muted); font-size:12px; border:1px solid var(--line); padding:5px 10px; border-radius:999px}
    table{width:100%; border-collapse:collapse}
    th, td{padding:12px 16px; border-bottom:1px solid rgba(27,42,58,.65); vertical-align:top}
    th{color:var(--muted); font-size:12px; text-transform:none; font-weight:600}
    .title{font-weight:700}
    .meta{color:var(--muted); font-size:12px; margin-top:2px}
    .status{
      display:inline-block; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .status.live{color:#ffd36a; border-color:rgba(255,211,106,.25)}
    .status.good{color:var(--good); border-color:rgba(36,209,139,.25)}
    .status.bad{color:var(--bad); border-color:rgba(255,91,91,.25)}
    .errline{padding:12px 16px; color:var(--bad); border-top:1px solid rgba(27,42,58,.65)}
    .mutedline{padding:12px 16px; color:var(--muted); border-top:1px solid rgba(27,42,58,.65)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TechApex Sports Fixtures</h1>
    <p class="sub">GitHub Pages frontend • Cloudflare Worker API</p>

    <div class="bar">
      <select id="sport"></select>
      <select id="league"></select>
      <select id="view"></select>

      <button id="loadBtn">Load</button>

      <label title="Auto refresh">
        <input type="checkbox" id="auto" />
        Auto refresh
      </label>
      <select id="refresh">
        <option value="10">10s</option>
        <option value="30" selected>30s</option>
        <option value="60">60s</option>
        <option value="120">120s</option>
      </select>

      <span class="spacer"></span>
      <span id="statusPill" class="pill">Idle</span>
    </div>

    <div class="card" id="card">
      <div class="cardhead">
        <h2 id="cardTitle">—</h2>
        <span class="count" id="count">0 items</span>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:260px">Date / Time (UK)</th>
            <th>Event</th>
            <th style="width:150px; text-align:right">Status</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <div id="footer" class="mutedline">Select a sport and press Load.</div>
    </div>
  </div>

<script>
  // ✅ SET THIS to your worker
  const API_BASE = "https://football-api.aollaku.workers.dev";

  // Football competitions (football-data.org codes)
  const FOOTBALL_LEAGUES = [
    { id:"PL",  name:"Premier League (PL)" },
    { id:"ELC", name:"EFL Championship (ELC)" },
    { id:"EL1", name:"EFL League One (EL1)" },
    { id:"EL2", name:"EFL League Two (EL2)" },

    { id:"CL",  name:"UEFA Champions League (CL)" },
    { id:"BL1", name:"Bundesliga (BL1)" },
    { id:"SA",  name:"Serie A (SA)" },
    { id:"PD",  name:"La Liga (PD)" },
    // Saudi league is not guaranteed on football-data.org free tiers; keep only if you know it works:
    // { id:"SPL", name:"Saudi Pro League (SPL)" },
  ];

  const SPORTS = [
    {
      id: "football",
      name: "Football",
      leagues: FOOTBALL_LEAGUES,
      views: [
        { id:"upcoming", name:"Upcoming" },
        { id:"live", name:"Live now" },
        { id:"finished", name:"Finished" }
      ]
    },
    {
      id: "motorsport",
      name: "Motorsport",
      leagues: [
        { id:"f1", name:"Formula 1" },
        { id:"fe", name:"Formula E" },
        { id:"motogp", name:"MotoGP" },
      ],
      views: [
        { id:"next", name:"Next race" },
        { id:"calendar", name:"Full calendar" },
        { id:"last", name:"Last event" },

        // F1-only extra views (handled automatically)
        { id:"results", name:"Last race result (F1 only)" },
        { id:"drivers", name:"Driver standings (F1 only)" },
        { id:"constructors", name:"Constructor standings (F1 only)" },
      ]
    }
  ];

  const sportSel = document.getElementById("sport");
  const leagueSel = document.getElementById("league");
  const viewSel = document.getElementById("view");
  const loadBtn = document.getElementById("loadBtn");
  const rowsEl = document.getElementById("rows");
  const cardTitle = document.getElementById("cardTitle");
  const countEl = document.getElementById("count");
  const footerEl = document.getElementById("footer");
  const statusPill = document.getElementById("statusPill");
  const autoChk = document.getElementById("auto");
  const refreshSel = document.getElementById("refresh");

  let timer = null;

  function setPill(ok, text){
    statusPill.className = "pill " + (ok === true ? "good" : ok === false ? "bad" : "");
    statusPill.textContent = text;
  }

  function fmtUk(dtUtcMs){
    const d = new Date(dtUtcMs);
    return d.toLocaleString("en-GB", {
      timeZone: "Europe/London",
      weekday: "short",
      day: "2-digit",
      month: "short",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  function clearTable(){
    rowsEl.innerHTML = "";
    countEl.textContent = "0 items";
  }

  function fillSelect(select, items, selectedId){
    select.innerHTML = "";
    for(const it of items){
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = it.name;
      select.appendChild(opt);
    }
    if(selectedId) select.value = selectedId;
  }

  function currentSport(){
    return SPORTS.find(s => s.id === sportSel.value) || SPORTS[0];
  }

  function rebuildDropdowns(keepLeague, keepView){
    const s = currentSport();

    // leagues
    const prevLeague = keepLeague ? leagueSel.value : null;
    fillSelect(leagueSel, s.leagues, prevLeague && s.leagues.some(x => x.id === prevLeague) ? prevLeague : s.leagues[0]?.id);

    // views
    const prevView = keepView ? viewSel.value : null;
    fillSelect(viewSel, s.views, prevView && s.views.some(x => x.id === prevView) ? prevView : s.views[0]?.id);
  }

  function buildUrl(){
    const sport = sportSel.value;
    const league = leagueSel.value;
    const view = viewSel.value;

    if(sport === "football"){
      // Map view -> football-data.org status parameter
      const status =
        view === "live" ? "IN_PLAY" :
        view === "finished" ? "FINISHED" :
        "SCHEDULED";

      const upstream = `https://api.football-data.org/v4/competitions/${league}/matches?status=${status}`;
      return `${API_BASE}/?url=${encodeURIComponent(upstream)}`;
    }

    // Motorsport
    if(league === "f1"){
      // F1 has dedicated endpoint
      const mappedView =
        (view === "next") ? "upcoming" :
        (view === "calendar") ? "calendar" :
        (view === "last") ? "results" : // last event -> last race result for F1
        view; // results/drivers/constructors
      return `${API_BASE}/v2/f1?view=${encodeURIComponent(mappedView)}&season=current`;
    }

    // FE / MotoGP schedule via iCal
    // allowed views: next|calendar|last
    const v = (view === "next" || view === "calendar" || view === "last") ? view : "next";
    return `${API_BASE}/v2/motorsport?series=${encodeURIComponent(league)}&view=${encodeURIComponent(v)}`;
  }

  function footballLiveMinuteApprox(utcKickoff){
    const now = Date.now();
    const mins = Math.floor((now - utcKickoff) / 60000);
    if (mins < 0) return null;
    // crude "match minute"
    return mins <= 120 ? mins : null;
  }

  function renderFootball(data, statusView){
    const matches = Array.isArray(data?.matches) ? data.matches : [];
    clearTable();
    cardTitle.textContent = (data?.competition?.name || "Football");
    countEl.textContent = `${matches.length} matches`;

    if(matches.length === 0){
      footerEl.className = "mutedline";
      footerEl.textContent = "No items returned.";
      return;
    }

    footerEl.className = "mutedline";
    footerEl.textContent = "";

    for(const m of matches){
      const dt = Date.parse(m.utcDate);
      const home = m?.homeTeam?.name || "Home";
      const away = m?.awayTeam?.name || "Away";
      const st = m?.status || "";
      const score = m?.score?.fullTime;
      const ft = (score && (score.home != null || score.away != null))
        ? ` (${score.home ?? "-"}-${score.away ?? "-"})`
        : "";

      // LIVE approximation if IN_PLAY
      let label = st;
      let pillClass = "status";
      if(st === "IN_PLAY"){
        const mm = footballLiveMinuteApprox(dt);
        label = mm != null ? `LIVE ${mm}'` : "LIVE";
        pillClass = "status live";
      } else if(st === "FINISHED"){
        pillClass = "status good";
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div class="title">${fmtUk(dt)}</div>
          <div class="meta">Matchday ${m.matchday ?? "-"}</div>
        </td>
        <td>
          <div class="title">${home} vs ${away}${ft}</div>
          <div class="meta">${m?.stage || ""}</div>
        </td>
        <td style="text-align:right">
          <span class="${pillClass}">${label}</span>
        </td>
      `;
      rowsEl.appendChild(tr);
    }
  }

  function renderF1(ergast){
    // Ergast-like structure
    clearTable();
    cardTitle.textContent = "Formula 1";
    footerEl.className = "mutedline";
    footerEl.textContent = "";

    const mr = ergast?.MRData;
    if(!mr){
      footerEl.className = "errline";
      footerEl.textContent = "Error: Unexpected response.";
      return;
    }

    // Try races
    const races = mr?.RaceTable?.Races || [];
    const driverStandings = mr?.StandingsTable?.StandingsLists?.[0]?.DriverStandings || [];
    const constructorStandings = mr?.StandingsTable?.StandingsLists?.[0]?.ConstructorStandings || [];

    if(races.length){
      countEl.textContent = `${races.length} races`;
      for(const r of races){
        const dt = Date.parse(`${r.date}T${(r.time || "00:00:00Z")}`);
        const circuit = r?.Circuit?.circuitName || "";
        const loc = r?.Circuit?.Location ? `${r.Circuit.Location.locality}, ${r.Circuit.Location.country}` : "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><div class="title">${fmtUk(dt)}</div><div class="meta">${r.date}</div></td>
          <td>
            <div class="title">${r.raceName} (Round ${r.round})</div>
            <div class="meta">${circuit}${loc ? " — " + loc : ""}</div>
          </td>
          <td style="text-align:right"><span class="status">Scheduled</span></td>
        `;
        rowsEl.appendChild(tr);
      }
      return;
    }

    if(driverStandings.length){
      cardTitle.textContent = "F1 Driver Standings";
      countEl.textContent = `${driverStandings.length} drivers`;
      for(const d of driverStandings){
        const name = `${d.Driver.givenName} ${d.Driver.familyName}`;
        const team = d.Constructors?.[0]?.name || "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><div class="title">#${d.position}</div><div class="meta">${d.points} pts</div></td>
          <td><div class="title">${name}</div><div class="meta">${team}</div></td>
          <td style="text-align:right"><span class="status">${d.wins} wins</span></td>
        `;
        rowsEl.appendChild(tr);
      }
      return;
    }

    if(constructorStandings.length){
      cardTitle.textContent = "F1 Constructor Standings";
      countEl.textContent = `${constructorStandings.length} teams`;
      for(const c of constructorStandings){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><div class="title">#${c.position}</div><div class="meta">${c.points} pts</div></td>
          <td><div class="title">${c.Constructor.name}</div><div class="meta"></div></td>
          <td style="text-align:right"><span class="status">${c.wins} wins</span></td>
        `;
        rowsEl.appendChild(tr);
      }
      return;
    }

    footerEl.className = "mutedline";
    footerEl.textContent = "No items returned.";
  }

  function renderIcalSeries(data, seriesName){
    clearTable();
    cardTitle.textContent = seriesName;
    const items = Array.isArray(data?.items) ? data.items : [];
    countEl.textContent = `${items.length} items`;

    if(!items.length){
      footerEl.className = "mutedline";
      footerEl.textContent = "No items returned.";
      return;
    }

    footerEl.className = "mutedline";
    footerEl.textContent = "";

    for(const it of items){
      const dt = it.startUtc;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><div class="title">${fmtUk(dt)}</div><div class="meta">${new Date(dt).toISOString().slice(0,10)}</div></td>
        <td>
          <div class="title">${escapeHtml(it.title)}</div>
          <div class="meta">${escapeHtml(it.location || "")}</div>
        </td>
        <td style="text-align:right"><span class="status">Scheduled</span></td>
      `;
      rowsEl.appendChild(tr);
    }
  }

  function escapeHtml(s){
    return String(s || "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  async function load(){
    setPill(null, "Loading…");
    footerEl.className = "mutedline";
    footerEl.textContent = "";
    clearTable();

    const sport = sportSel.value;
    const league = leagueSel.value;
    const view = viewSel.value;

    const apiUrl = buildUrl();

    try{
      const res = await fetch(apiUrl, { cache: "no-store" });
      const text = await res.text();

      let data;
      try { data = JSON.parse(text); }
      catch {
        setPill(false, `Error ${res.status}`);
        footerEl.className = "errline";
        footerEl.textContent = "Error: Upstream not JSON";
        return;
      }

      if(!res.ok){
        // Show useful message for football-data.org restrictions
        setPill(false, `Error ${res.status}`);
        footerEl.className = "errline";
        footerEl.textContent = data?.message || data?.error || `Request failed (${res.status}).`;
        return;
      }

      setPill(true, "Updated");

      if(sport === "football"){
        renderFootball(data, view);
        return;
      }

      // Motorsport
      if(league === "f1"){
        renderF1(data);
        return;
      }

      // FE/MotoGP calendar JSON
      const seriesName =
        league === "fe" ? "Formula E" :
        league === "motogp" ? "MotoGP" :
        "Motorsport";
      renderIcalSeries(data, seriesName);

    }catch(e){
      setPill(false, "Error");
      footerEl.className = "errline";
      footerEl.textContent = "Error: Failed to fetch";
    }
  }

  function resetTimer(){
    if(timer) clearInterval(timer);
    timer = null;
    if(autoChk.checked){
      const sec = Number(refreshSel.value || 30);
      timer = setInterval(load, sec * 1000);
    }
  }

  // Init UI
  fillSelect(sportSel, SPORTS.map(s => ({id:s.id, name:s.name})), "football");
  rebuildDropdowns(false,false);

  sportSel.addEventListener("change", () => {
    rebuildDropdowns(false,false); // rebuild leagues/views for new sport
    resetTimer();
  });

  leagueSel.addEventListener("change", () => resetTimer());
  viewSel.addEventListener("change", () => resetTimer());
  autoChk.addEventListener("change", () => resetTimer());
  refreshSel.addEventListener("change", () => resetTimer());

  loadBtn.addEventListener("click", load);

  setPill(null, "Idle");
</script>
</body>
</html>
