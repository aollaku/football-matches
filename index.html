<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TechApex Sports Fixtures</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0f14;
      color: #e7eef7;
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 28px 18px 60px; }
    h1 { margin: 0 0 4px; font-size: 26px; }
    .sub { opacity: .75; margin-bottom: 18px; }
    .bar {
      display: flex; gap: 10px; flex-wrap: wrap;
      align-items: center;
      padding: 14px;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    select, button {
      background: rgba(255,255,255,.06);
      color: #e7eef7;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    button { cursor: pointer; }
    button:hover { background: rgba(255,255,255,.10); }

    .pill {
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      opacity: .85;
    }
    .pill.ok { border-color: rgba(0,255,160,.25); }
    .pill.err { border-color: rgba(255,80,80,.35); color: #ffb3b3; }

    .card {
      margin-top: 18px;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      overflow: hidden;
      background: rgba(255,255,255,.03);
    }
    .cardHead {
      display:flex; justify-content: space-between; align-items:center;
      padding: 14px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-weight: 650;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      vertical-align: top;
    }
    th { text-align: left; font-size: 12px; opacity: .8; }
    .muted { opacity: .75; font-size: 12px; margin-top: 2px; }
    .status {
      display:inline-block; padding: 4px 10px; border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      white-space: nowrap;
    }
    .errorLine { color: #ffb3b3; padding: 12px 14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TechApex Sports Fixtures</h1>
    <div class="sub">GitHub Pages frontend • Cloudflare Worker API</div>

    <div class="bar">
      <select id="sport"></select>
      <select id="league"></select>
      <select id="view"></select>
      <button id="load">Load</button>
      <span id="status" class="pill ok">Ready</span>
    </div>

    <div class="card">
      <div class="cardHead">
        <div id="title">—</div>
        <div class="pill" id="countPill">0 items</div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width: 220px;">Date / Time (UK)</th>
            <th>Event</th>
            <th style="width: 140px;">Status</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="3" class="muted">Choose options then press Load.</td></tr>
        </tbody>
      </table>

      <div id="err" class="errorLine" style="display:none;"></div>
    </div>
  </div>

<script>
(() => {
  // IMPORTANT: set this to your Worker hostname (you’re using this already)
  const WORKER_BASE = "https://football-api.aollaku.workers.dev";

  const $sport = document.getElementById("sport");
  const $league = document.getElementById("league");
  const $view = document.getElementById("view");
  const $load = document.getElementById("load");
  const $status = document.getElementById("status");
  const $rows = document.getElementById("rows");
  const $title = document.getElementById("title");
  const $count = document.getElementById("countPill");
  const $err = document.getElementById("err");

  const SPORTS = [
    { id: "football", name: "Football" },
    { id: "motorsport", name: "Motorsport" },
  ];

  // Football competitions (football-data.org codes)
  // Keep these as you had them; add more as needed.
  const FOOTBALL_LEAGUES = [
    { id: "PL",  name: "Premier League (PL)" },
    { id: "ELC", name: "EFL Championship (ELC)" },
    { id: "EL1", name: "EFL League One (EL1)" },
    { id: "EL2", name: "EFL League Two (EL2)" },
    { id: "CL",  name: "UEFA Champions League (CL)" },
    { id: "BL1", name: "Bundesliga (BL1)" },
    { id: "SA",  name: "Serie A (SA)" },
    { id: "PD",  name: "La Liga (PD)" },
  ];

  // Motorsport series
  const MOTORSPORT_LEAGUES = [
    { id: "f1",     name: "Formula 1" },
    { id: "fe",     name: "Formula E" },
    { id: "motogp", name: "MotoGP" },
    { id: "wec",    name: "WEC" },
  ];

  const FOOTBALL_VIEWS = [
    { id: "upcoming", name: "Upcoming" },
    { id: "live",     name: "Live now" },
    { id: "finished", name: "Finished" },
  ];

  const MOTORSPORT_VIEWS = [
    { id: "next",     name: "Next race" },
    { id: "calendar", name: "Full calendar" },
    { id: "last",     name: "Last round (schedule)" },
    { id: "drivers",  name: "Driver standings (F1 only)" },
    { id: "teams",    name: "Constructor standings (F1 only)" },
  ];

  function setStatus(text, ok=true) {
    $status.textContent = text;
    $status.className = "pill " + (ok ? "ok" : "err");
  }

  function clearError() {
    $err.style.display = "none";
    $err.textContent = "";
  }
  function showError(msg) {
    $err.style.display = "block";
    $err.textContent = "Error: " + msg;
  }

  function fillSelect(sel, items, selectedId) {
    sel.innerHTML = "";
    items.forEach(it => {
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = it.name;
      if (selectedId && selectedId === it.id) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  function rebuildDropdowns() {
    const sport = $sport.value;

    if (sport === "football") {
      fillSelect($league, FOOTBALL_LEAGUES, "PL");
      fillSelect($view, FOOTBALL_VIEWS, "upcoming");
    } else {
      fillSelect($league, MOTORSPORT_LEAGUES, "f1");
      fillSelect($view, MOTORSPORT_VIEWS, "next");
    }
  }

  function ukDateTimeFromUTC(iso) {
    if (!iso) return "—";
    try {
      const d = new Date(iso);
      const fmt = new Intl.DateTimeFormat("en-GB", {
        timeZone: "Europe/London",
        weekday: "short", day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit"
      });
      return fmt.format(d);
    } catch {
      return iso;
    }
  }

  function renderRows(items, mode="generic") {
    $rows.innerHTML = "";
    if (!items || !items.length) {
      $rows.innerHTML = `<tr><td colspan="3" class="muted">No items returned.</td></tr>`;
      return;
    }

    for (const it of items) {
      const dateText = it.utcDate ? ukDateTimeFromUTC(it.utcDate) : (it.dateUK || it.dateText || "—");
      const status = it.status || "—";

      let eventHtml = "";
      if (mode === "football") {
        eventHtml = `<div><strong>${it.homeTeam} vs ${it.awayTeam}${it.score ? " ("+it.score+")" : ""}</strong></div>
                     <div class="muted">${it.competitionStage || ""}${it.matchday ? " • Matchday "+it.matchday : ""}</div>`;
      } else if (mode === "motorsport") {
        eventHtml = `<div><strong>${it.event || "—"}${it.round ? " (Round " + it.round + ")" : ""}</strong></div>
                     <div class="muted">${[it.circuit, it.location].filter(Boolean).join(" — ")}</div>`;
      } else {
        eventHtml = `<div><strong>${it.event || it.name || "—"}</strong></div>`;
      }

      $rows.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${dateText}<div class="muted">${it.utcDate ? it.utcDate : ""}</div></td>
          <td>${eventHtml}</td>
          <td><span class="status">${status}</span></td>
        </tr>
      `);
    }
  }

  // ----------------- API builders -----------------

  function buildFootballUpstream(leagueCode, view) {
    // football-data.org API
    // status: SCHEDULED | LIVE | FINISHED
    let status = "SCHEDULED";
    if (view === "live") status = "LIVE";
    if (view === "finished") status = "FINISHED";
    return `https://api.football-data.org/v4/competitions/${leagueCode}/matches?status=${status}`;
  }

  function buildFootballWorkerUrl(upstreamUrl) {
    return `${WORKER_BASE}/?url=${encodeURIComponent(upstreamUrl)}`;
  }

  function buildF1Url(view) {
    // maps UI views to Worker /v2/f1 view values
    const map = {
      next: "upcoming",
      calendar: "calendar",
      last: "results",
      drivers: "drivers",
      teams: "constructors",
    };
    const v = map[view] || "upcoming";
    return `${WORKER_BASE}/v2/f1?view=${encodeURIComponent(v)}`;
  }

  function buildMotorsportUrl(series, view) {
    // our Worker /v2/motorsport endpoint (Wikipedia calendars)
    // only supports next/calendar/last
    const safeView = (view === "next" || view === "calendar" || view === "last") ? view : "next";
    return `${WORKER_BASE}/v2/motorsport?series=${encodeURIComponent(series)}&view=${encodeURIComponent(safeView)}`;
  }

  // ----------------- loaders -----------------

  async function loadData() {
    clearError();
    setStatus("Loading…", true);

    const sport = $sport.value;
    const league = $league.value;
    const view = $view.value;

    let url = "";

    try {
      if (sport === "football") {
        const upstream = buildFootballUpstream(league, view);
        url = buildFootballWorkerUrl(upstream);
        $title.textContent = FOOTBALL_LEAGUES.find(x=>x.id===league)?.name || "Football";
        const r = await fetch(url);
        const j = await r.json();

        if (!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);

        const matches = (j?.matches || []).map(m => {
          const score =
            (m?.score?.fullTime?.home != null && m?.score?.fullTime?.away != null)
              ? `${m.score.fullTime.home}-${m.score.fullTime.away}`
              : (m?.score?.halfTime?.home != null && m?.score?.halfTime?.away != null)
                ? `${m.score.halfTime.home}-${m.score.halfTime.away} HT`
                : "";

          return {
            utcDate: m.utcDate,
            status: m.status,
            homeTeam: m.homeTeam?.name || "Home",
            awayTeam: m.awayTeam?.name || "Away",
            matchday: m.matchday,
            competitionStage: m.stage,
            score: score || "",
          };
        });

        $count.textContent = `${matches.length} items`;
        renderRows(matches, "football");
      } else {
        // Motorsport
        const leagueName = MOTORSPORT_LEAGUES.find(x=>x.id===league)?.name || "Motorsport";
        $title.textContent = leagueName;

        // F1 uses /v2/f1 for full feature set
        if (league === "f1") {
          url = buildF1Url(view);
          const r = await fetch(url);
          const j = await r.json();
          if (!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);

          // Normalize F1 shapes
          const MR = j?.MRData || {};
          const raceTable = MR?.RaceTable || {};
          const races = raceTable?.Races || [];

          // standings
          const driverStandings = MR?.StandingsTable?.StandingsLists?.[0]?.DriverStandings;
          const constructorStandings = MR?.StandingsTable?.StandingsLists?.[0]?.ConstructorStandings;

          let items = [];

          if (view === "drivers" && Array.isArray(driverStandings)) {
            items = driverStandings.map(d => ({
              dateText: "",
              event: `${d.position}. ${d.Driver?.givenName} ${d.Driver?.familyName} — ${d.points} pts`,
              circuit: d.Constructors?.[0]?.name || "",
              location: "",
              status: "Standings",
            }));
          } else if (view === "teams" && Array.isArray(constructorStandings)) {
            items = constructorStandings.map(t => ({
              dateText: "",
              event: `${t.position}. ${t.Constructor?.name} — ${t.points} pts`,
              circuit: "",
              location: "",
              status: "Standings",
            }));
          } else {
            items = races.map(race => ({
              dateUK: ukDateTimeFromUTC(`${race.date}T${race.time || "00:00:00Z"}`),
              event: `${race.raceName} (Round ${race.round})`,
              circuit: race.Circuit?.circuitName || "",
              location: `${race.Circuit?.Location?.locality || ""}${race.Circuit?.Location?.country ? ", " + race.Circuit.Location.country : ""}`,
              status: "Scheduled",
              round: race.round,
            }));
          }

          $count.textContent = `${items.length} items`;
          renderRows(items, "motorsport");
        } else {
          // Other motorsport (free calendar views only)
          if (view === "drivers" || view === "teams") {
            // Free sources don’t provide reliable standings for MotoGP/FE/WEC without paid feeds.
            $count.textContent = `0 items`;
            $rows.innerHTML = `<tr><td colspan="3" class="muted">
              Standings are only supported for Formula 1 (free Ergast/Jolpica).<br/>
              For ${leagueName}, choose Next race / Full calendar / Last round.
            </td></tr>`;
            setStatus("Loaded", true);
            return;
          }

          url = buildMotorsportUrl(league, view);
          const r = await fetch(url);
          const j = await r.json();
          if (!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);

          let items = [];
          if (view === "calendar") items = j.items || [];
          else items = j.item ? [j.item] : [];

          $count.textContent = `${items.length} items`;
          renderRows(items, "motorsport");
        }
      }

      setStatus("Updated", true);
    } catch (e) {
      setStatus("Error", false);
      showError(e?.message || String(e));
      $count.textContent = `0 items`;
      $rows.innerHTML = `<tr><td colspan="3" class="muted">No items returned.</td></tr>`;
      console.log("Last URL:", url);
    }
  }

  // init
  fillSelect($sport, SPORTS, "football");
  rebuildDropdowns();

  $sport.addEventListener("change", () => {
    rebuildDropdowns();
    clearError();
    setStatus("Ready", true);
  });

  $load.addEventListener("click", loadData);
})();
</script>
</body>
</html>
